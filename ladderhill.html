<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Ladder Dodge — Offline</title>
<style>
  html,body{height:100%;margin:0}
  body{background:#0b0e14;color:#e6e6e6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;display:flex;align-items:center;justify-content:center}
  #wrap{position:relative}
  canvas{background:linear-gradient(#111827,#0b0e14);border:1px solid #1f2937;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  .hint{position:absolute;left:0;right:0;bottom:8px;text-align:center;font-size:12px;color:#a5b4fc;pointer-events:none}
</style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" width="480" height="640" aria-label="Ladder Dodge Game"></canvas>
    <div class="hint">Arrows or A/D to move • Up/Down or W/S to climb • Enter to start • R to restart</div>
  </div>
<script>
(() => {
  const W=480, H=640;
  const g = document.getElementById('game');
  const ctx = g.getContext('2d');
  const TAU = Math.PI*2;

  // Level layout
  const platforms = [
    {x: 40,  y: 560, w: 400, h: 10},
    {x: 30,  y: 440, w: 420, h: 10},
    {x: 40,  y: 320, w: 400, h: 10},
    {x: 30,  y: 200, w: 420, h: 10},
    {x: 80,  y:  80, w: 320, h: 10}
  ];
  const ladders = [
    {x:120, y1:560, y2:440},
    {x:360, y1:560, y2:440},
    {x:220, y1:440, y2:320},
    {x:80,  y1:440, y2:320},
    {x:160, y1:320, y2:200},
    {x:400, y1:320, y2:200},
    {x:240, y1:200, y2: 80}
  ];

  const goal = {x: platforms[4].x + platforms[4].w - 24, y: platforms[4].y - 24, r: 10};

  // Player
  const player = {
    x: platforms[0].x + 12,
    y: platforms[0].y - 28,
    w: 18,
    h: 26,
    vx: 0,
    vy: 0,
    speed: 150,
    climbSpeed: 110,
    onGround: false,
    climbing: false,
    invuln: 0
  };

  // Balls
  let balls = [];
  let lastSpawn = 0;
  let spawnEvery = 1400; // ms
  let speedBoost = 0;    // increases over time

  // Game state
  let state = 'title'; // 'playing', 'gameover', 'win'
  let scoreTime = 0;    // ms survived
  let high = 0;
  const keys = {};

  // Input
  document.addEventListener('keydown', e => {
    keys[e.key] = true;
    if ((e.key === 'Enter' || e.key === ' ') && (state === 'title' || state === 'gameover' || state === 'win')) start();
    if (e.key === 'r' || e.key === 'R') reset();
  });
  document.addEventListener('keyup', e => keys[e.key] = false);

  function start(){
    reset();
    state = 'playing';
  }
  function reset(){
    balls = [];
    lastSpawn = 0;
    spawnEvery = 1400;
    speedBoost = 0;
    scoreTime = 0;
    player.x = platforms[0].x + 12;
    player.y = platforms[0].y - player.h - 2;
    player.vx = player.vy = 0;
    player.climbing = false;
    player.invuln = 0;
    state = 'title';
  }

  // Helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function circleRectHit(cx,cy,r,rx,ry,rw,rh){
    const nx = clamp(cx, rx, rx+rw);
    const ny = clamp(cy, ry, ry+rh);
    const dx = cx - nx, dy = cy - ny;
    return dx*dx + dy*dy <= r*r;
  }
  function playerOnLadder(){
    for(const L of ladders){
      const withinX = Math.abs(player.x + player.w/2 - L.x) < 12;
      const head = player.y;
      const feet = player.y + player.h;
      if (withinX && feet > L.y2 && head < L.y1) return L;
    }
    return null;
  }

  // Spawning balls
  function spawnBall(){
    const x = 30 + Math.random()*(W-60);
    balls.push({x, y:-12, r:10, vy: 110 + Math.random()*50 + speedBoost});
  }

  // Audio (tiny beep)
  let audioCtx;
  function beep(freq=440, dur=0.08, type='square', vol=0.05){
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(vol, t);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      o.connect(g).connect(audioCtx.destination);
      o.start(t); o.stop(t+dur);
    }catch(e){}
  }

  // Main loop
  let then = performance.now();
  function loop(now){
    const dt = Math.min(0.04, (now-then)/1000);
    then = now;

    update(dt, now);
    draw(now);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function update(dt, now){
    if (state === 'playing'){
      scoreTime += dt*1000;
      if (scoreTime > high) high = Math.floor(scoreTime);

      // Increase difficulty slowly
      speedBoost = Math.min(200, scoreTime/3000*30);
      spawnEvery = Math.max(500, 1400 - scoreTime/1000*80);

      if (now - lastSpawn > spawnEvery){
        lastSpawn = now;
        spawnBall();
      }

      // Input axes
      const left = keys['ArrowLeft']||keys['a']||keys['A'];
      const right = keys['ArrowRight']||keys['d']||keys['D'];
      const up = keys['ArrowUp']||keys['w']||keys['W'];
      const down = keys['ArrowDown']||keys['s']||keys['S'];

      // Ladder logic: only climb while actively pressing Up/Down
      const L = playerOnLadder();
      player.climbing = !!L && (up || down);

      if (player.climbing && L){
        // snap to ladder column and climb
        player.vx = 0;
        player.x = L.x - player.w/2;
        player.vy = up ? -player.climbSpeed : (down ? player.climbSpeed : 0);
      } else {
        // Horizontal move
        const accel = 900;
        const maxSpd = player.speed;
        if (left && !right) player.vx = Math.max(-maxSpd, player.vx - accel*dt);
        else if (right && !left) player.vx = Math.min(maxSpd, player.vx + accel*dt);
        else player.vx *= Math.pow(0.001, dt); // friction

        // Gravity
        player.vy += 900*dt;
      }

      // Integrate
      const prevY = player.y;
      player.x += player.vx*dt;
      player.y += player.vy*dt;

      // World bounds
      player.x = clamp(player.x, 0, W - player.w);
      if (player.y > H - player.h){ player.y = H - player.h; player.vy = 0; }

      // Step onto platform when reaching ladder top/bottom
      if (L && player.climbing){
        // Top of ladder -> onto upper platform
        if (player.y <= L.y2 - player.h){
          player.y = L.y2 - player.h;
          player.vy = 0;
          player.climbing = false;
          player.onGround = true;
        }
        // Bottom of ladder -> onto lower platform
        else if (player.y + player.h >= L.y1){
          player.y = L.y1 - player.h;
          player.vy = 0;
          player.climbing = false;
          player.onGround = true;
        }
      }

      // Platform collisions (landing from above)
      player.onGround = false;
      for (const p of platforms){
        const wasAbove = prevY + player.h <= p.y + 1;
        const nowCrossed = player.y + player.h >= p.y && player.y + player.h <= p.y + 12;
        const overlapX = player.x + player.w > p.x && player.x < p.x + p.w;
        if (!player.climbing && wasAbove && nowCrossed && overlapX){
          player.y = p.y - player.h;
          player.vy = 0; player.onGround = true;
        }
      }

      // Balls update
      for (const b of balls){
        b.vy += 8*dt; // tiny accel
        b.y += b.vy*dt;
      }
      // Remove off-screen balls
      balls = balls.filter(b => b.y - b.r < H+40);

      // Collisions with balls
      if (player.invuln > 0) player.invuln -= dt;
      for (const b of balls){
        if (circleRectHit(b.x,b.y,b.r, player.x,player.y,player.w,player.h)){
          if (player.invuln <= 0){
            state = 'gameover';
            beep(200,0.15,'sawtooth',0.08);
          }
        }
      }

      // Win if reach goal
      if (circleRectHit(goal.x, goal.y, goal.r+6, player.x,player.y,player.w,player.h)){
        state = 'win';
        beep(880,0.12,'triangle',0.06); setTimeout(()=>beep(1320,0.12,'triangle',0.06),100);
      }
    }
  }

  function draw(now){
    // background
    ctx.clearRect(0,0,W,H);
    const grd=ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#0f172a');
    grd.addColorStop(1,'#0b0e14');
    ctx.fillStyle=grd; ctx.fillRect(0,0,W,H);

    // Platforms
    for (const p of platforms){
      ctx.fillStyle = '#26324a';
      ctx.fillRect(p.x, p.y, p.w, p.h);
      ctx.fillStyle = '#3b82f6';
      ctx.fillRect(p.x, p.y-2, p.w, 2);
    }

    // Ladders
    for (const L of ladders){
      ctx.strokeStyle = '#f59e0b';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(L.x-8, L.y1); ctx.lineTo(L.x-8, L.y2);
      ctx.moveTo(L.x+8, L.y1); ctx.lineTo(L.x+8, L.y2);
      ctx.stroke();
      ctx.strokeStyle = '#fbbf24';
      ctx.lineWidth = 2;
      for (let y=L.y1; y>=L.y2; y-=14){
        ctx.beginPath();
        ctx.moveTo(L.x-10, y); ctx.lineTo(L.x+10, y);
        ctx.stroke();
      }
    }

    // Goal flag
    ctx.save();
    ctx.translate(goal.x, goal.y);
    ctx.fillStyle = '#10b981';
    ctx.beginPath(); ctx.arc(0,0, goal.r, 0, TAU); ctx.fill();
    ctx.fillStyle = '#064e3b'; ctx.fillRect(-2, goal.r, 4, 14);
    ctx.restore();

    // Player
    ctx.save();
    const blink = (state==='playing' && player.invuln>0 && ((now/100)%2<1));
    ctx.globalAlpha = blink?0.3:1;
    ctx.fillStyle = '#e11d48';
    ctx.fillRect(player.x, player.y, player.w, player.h);
    // face
    ctx.fillStyle = '#fff';
    ctx.fillRect(player.x+4, player.y+6, 3,3);
    ctx.fillRect(player.x+11, player.y+6, 3,3);
    ctx.restore();

    // Balls
    for (const b of balls){
      const r = b.r;
      const grad = ctx.createRadialGradient(b.x, b.y, 1, b.x, b.y, r*2);
      grad.addColorStop(0, 'rgba(250,204,21,0.9)');
      grad.addColorStop(1, 'rgba(245,158,11,0)');
      ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(b.x, b.y, r*2.2, 0, TAU); ctx.fill();
      ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.arc(b.x, b.y, r, 0, TAU); ctx.fill();
      ctx.strokeStyle = '#a16207'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(b.x, b.y, r-1, 0, TAU); ctx.stroke();
    }

    // HUD
    ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.fillRect(10,10, 160, 42);
    ctx.fillStyle = '#cbd5e1'; ctx.font = '12px system-ui, sans-serif';
    ctx.fillText('Time: ' + (scoreTime/1000).toFixed(1) + 's', 18, 26);
    ctx.fillText('High: ' + (high/1000).toFixed(1) + 's', 18, 42);

    // Titles & prompts
    ctx.textAlign='center';
    if (state==='title'){
      titleText('LADDER DODGE', 'Press Enter to start');
    } else if (state==='gameover'){
      titleText('GAME OVER', 'Press Enter to try again');
    } else if (state==='win'){
      titleText('YOU REACHED THE GOAL!', 'Press Enter to play again');
    }
  }

  function titleText(main, sub){
    ctx.fillStyle='rgba(0,0,0,0.55)';
    ctx.fillRect(40, H/2-80, W-80, 140);
    ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.lineWidth=2; ctx.strokeRect(40, H/2-80, W-80, 140);
    ctx.fillStyle='#e5e7eb'; ctx.font='bold 26px system-ui, sans-serif';
    ctx.fillText(main, W/2, H/2-26);
    ctx.fillStyle='#a5b4fc'; ctx.font='14px system-ui, sans-serif';
    ctx.fillText(sub, W/2, H/2+6);
    ctx.fillStyle='#94a3b8'; ctx.font='12px system-ui, sans-serif';
    ctx.fillText('Move: ← → or A/D • Climb: ↑ ↓ or W/S • Restart: R', W/2, H/2+28);
  }
})();
</script>
</body>
</html>
